package com.project.chatconnectbackend.controller.v1;

import java.util.HashMap;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.bind.annotation.RestController;

import com.project.chatconnectbackend.model.User;
import com.project.chatconnectbackend.repository.UserRepository;

@RestController // This means that this class is a Controller
@RequestMapping(path = "/api/v1") // This means URL's start with /api/v1 (after Application path)
public class ControllerV1 {
  @Autowired // This means to get the bean called userRepository
  // Which is auto-generated by Spring, we will use it to handle the data
  private UserRepository userRepository;

  @PostMapping(path = "/register", produces = "application/json") // Map ONLY POST Requests
  public @ResponseBody ResponseEntity<Map<String, Object>> registerNewUser(
      @RequestParam String name,
      @RequestParam String phone,
      @RequestParam String password) {
    try {
      // @ResponseBody means the returned String is the response, not a view name
      // @RequestParam means it is a parameter from the GET or POST request
      User newUser = new User();
      // Split name by space
      String[] nameParts = name.split(" ");

      // Check if name has only one part (no spaces)
      String firstName;
      String lastName;
      if (nameParts.length == 1) {
          firstName = nameParts[0].trim(); // Use entire name as first name
          lastName = ""; // Set last name to empty string
      } else {
          // Use first part as first name and remaining parts as last name
          firstName = nameParts[0].trim();
          lastName = name.substring(name.indexOf(" ") + 1).trim();
      }
      newUser.setFirst_name(firstName);
      newUser.setLast_name(lastName);
      newUser.setPhone_number(phone);
      newUser.setPassword(password);
      newUser.setProfile_photo("default.jpg");
      userRepository.save(newUser);

      // Create the response body
      Map<String, Object> responseBody = new HashMap<>();
      responseBody.put("status", "success");
      responseBody.put("data", newUser);
      responseBody.put("message", "User Saved");

      return ResponseEntity.ok(responseBody);
    } catch (Exception e) {
      // Return an error response if an exception occurs
      Map<String, Object> errorResponseBody = new HashMap<>();
      errorResponseBody.put("status", "error");
      errorResponseBody.put("message", "An error occurred: " + e.getMessage());
      return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponseBody);
    }
  }

  @GetMapping(path = "/all")
  public @ResponseBody Iterable<User> getAllUsers() {
    // This returns a JSON or XML with the users
    return userRepository.findAll();
  }
}